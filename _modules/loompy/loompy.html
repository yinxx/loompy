

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>loompy.loompy &mdash; loompy 2.0.10 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> loompy
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to loompy!</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html#getting-started">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../semantics/index.html">Understanding the semantics of loom files</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apiwalkthrough/index.html">API Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook/index.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conventions/index.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fullapi/index.html">Complete API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../format/index.html">Loom file format specs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">loompy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>loompy.loompy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for loompy.loompy</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2015 Sten Linnarsson</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#   list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#   this list of conditions and the following disclaimer in the documentation</span>
<span class="c1">#   and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="c1"># FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="c1"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="c1"># SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="c1"># OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">mmread</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">copyfile</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">loompy</span>
<span class="kn">from</span> <span class="nn">loompy</span> <span class="k">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">timestamp</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
	<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
	<span class="kn">import</span> <span class="nn">h5py</span>


<div class="viewcode-block" id="LoomConnection"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection">[docs]</a><span class="k">class</span> <span class="nc">LoomConnection</span><span class="p">:</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Establish a connection to a .loom file.</span>

<span class="sd">		Args:</span>
<span class="sd">			filename:			Name of the .loom file to open</span>
<span class="sd">			mode:				read/write mode, accepts &#39;r+&#39; (read/write) or</span>
<span class="sd">								&#39;r&#39; (read-only), defaults to &#39;r+&#39; without arguments,</span>
<span class="sd">								and to &#39;r&#39; with incorrect arguments</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># make sure a valid mode was passed, if not default to read-only</span>
		<span class="c1"># because you probably are doing something that you don&#39;t want to</span>
		<span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;r+&#39;</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be either &#39;r&#39; or &#39;r+&#39;&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="s2">&quot;matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s2">&quot;/matrix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">ViewManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">FileAttributeManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">GraphManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">GraphManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

			<span class="c1"># Compatibility</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span>

		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;initialising LoomConnection to </span><span class="si">%s</span><span class="s2"> failed, closing file connection&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="LoomConnection.last_modified"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.last_modified">[docs]</a>	<span class="k">def</span> <span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return an ISO8601 timestamp when the file was last modified</span>

<span class="sd">		Note: if the file has no timestamp, and mode is &#39;r+&#39;, a new timestamp is created and returned.</span>
<span class="sd">		Otherwise, the current time in UTC is returned</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="s2">&quot;last_modified&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
			<span class="c1"># Make sure the file has modification timestamps</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">timestamp</span><span class="p">()</span></div>

<div class="viewcode-block" id="LoomConnection.get_changes_since"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.get_changes_since">[docs]</a>	<span class="k">def</span> <span class="nf">get_changes_since</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
		<span class="n">rg</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">cg</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ca</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">rg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">cg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">ra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">ca</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;row_graphs&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;col_graphs&quot;</span><span class="p">:</span> <span class="n">cg</span><span class="p">,</span> <span class="s2">&quot;row_attrs&quot;</span><span class="p">:</span> <span class="n">ra</span><span class="p">,</span> <span class="s2">&quot;col_attrs&quot;</span><span class="p">:</span> <span class="n">ca</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">}</span></div>

	<span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Context manager, to support &quot;with loompy.connect(..)&quot; construct</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span>

	<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Context manager, to support &quot;with loompy.connect(..)&quot; construct</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return an HTML representation of the loom file, showing the upper-left 10x10 corner.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">loompy</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;This LoomConnection has been closed&quot;</span>

	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get a slice of the main matrix.</span>

<span class="sd">		Args:</span>
<span class="sd">			slice:		A slice object (see http://docs.h5py.org/en/latest/high/dataset.html), or np.ndarray, or int</span>

<span class="sd">		Returns:</span>
<span class="sd">			A numpy ndarray matrix</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">slice_</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slice must be a 2-tuple&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">slice_</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Assign a slice of the main matrix.</span>

<span class="sd">		Args:</span>
<span class="sd">			slice_:		A slice object (see http://docs.h5py.org/en/latest/high/dataset.html), or np.ndarray, or int</span>
<span class="sd">			data:		A matrix corresponding to the slice, of the same datatype as the main matrix</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">slice_</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">slice_</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

<div class="viewcode-block" id="LoomConnection.sparse"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.sparse">[docs]</a>	<span class="k">def</span> <span class="nf">sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return the main matrix as a scipy.sparse.coo_matrix, without loading dense matrix in RAM</span>

<span class="sd">		Args:</span>
<span class="sd">			rows:		Rows to include, or None to include all</span>
<span class="sd">			cols:		Columns to include, or None to include all</span>
<span class="sd">			layer:		Layer to return, or None to return the default layer</span>

<span class="sd">		Returns:</span>
<span class="sd">			scipy.sparse.coo_matrix</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.close"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.close">[docs]</a>	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Close the connection. After this, the connection object becomes invalid. Warns user if called after closing.</span>

<span class="sd">		Args:</span>
<span class="sd">			suppress_warning:		Suppresses warning message if True (defaults to false)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warning</span><span class="p">:</span>
				<span class="c1"># Warn user that they&#39;re being paranoid</span>
				<span class="c1"># and should clean up their code</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Connection to </span><span class="si">%s</span><span class="s2"> is already closed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span></div>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span>

<div class="viewcode-block" id="LoomConnection.set_layer"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.set_layer">[docs]</a>	<span class="k">def</span> <span class="nf">set_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">chunk_cache</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.layer.Name = matrix` or `ds.layer[`Name`] = matrix` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;set_layer&#39; is deprecated. Use &#39;ds.layer.Name = matrix&#39; or &#39;ds.layer[&#39;Name&#39;] = matrix&#39; instead&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span></div>

<div class="viewcode-block" id="LoomConnection.add_columns"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.add_columns">[docs]</a>	<span class="k">def</span> <span class="nf">add_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add columns of data and attribute values to the dataset.</span>

<span class="sd">		Args:</span>
<span class="sd">			layers (dict or numpy.ndarray or LayerManager):</span>
<span class="sd">				Either:</span>
<span class="sd">				1) A N-by-M matrix of float32s (N rows, M columns) in this case columns are added at the default layer</span>
<span class="sd">				2) A dict {layer_name : matrix} specified so that the matrix (N, M) will be added to layer `layer_name`</span>
<span class="sd">				3) A LayerManager object (such as what is returned by view.layers)</span>
<span class="sd">			col_attrs (dict):</span>
<span class="sd">				Column attributes, where keys are attribute names and values are numpy arrays (float or string) of length M</span>
<span class="sd">			fill_values: dictionary of values to use if a column attribute is missing, or &quot;auto&quot; to fill with zeros or empty strings</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		- This will modify the underlying HDF5 file, which will interfere with any concurrent readers.</span>
<span class="sd">		- Column attributes in the file that are NOT provided, will be deleted (unless fill value provided).</span>
<span class="sd">		- Array with Nan should not be provided</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot add columns when connected in read-only mode&quot;</span><span class="p">)</span>

		<span class="n">layers_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
			<span class="n">layers_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">}</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">):</span>
			<span class="n">layers_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="n">layers_dict</span> <span class="o">=</span> <span class="n">layers</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid type for layers argument&quot;</span><span class="p">)</span>
		<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">layers_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> does not exist in the target loom file&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> has </span><span class="si">{matrix.shape[0]}</span><span class="s2"> rows but file has </span><span class="si">{self.shape[0]}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">n_cols</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">elif</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_cols</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> has </span><span class="si">{matrix.shape[1]}</span><span class="s2"> columns but the first layer had </span><span class="si">{n_cols}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layers_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> does not exist in the target loom file&quot;</span><span class="p">)</span>

		<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="n">todel</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fill_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">fill_values</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">fill_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fill_with</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">todel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_cols</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Each column attribute must have exactly </span><span class="si">{n_cols}</span><span class="s2"> values, but </span><span class="si">{key}</span><span class="s2"> had {len(vals)}&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
			<span class="k">del</span> <span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">did_remove</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Some column attributes were removed: &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">todel</span><span class="p">))</span>

		<span class="n">todel</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fill_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">fill_values</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">fill_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fill_with</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">todel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># delete_attr(key, axis=1)</span>
		<span class="k">if</span> <span class="n">did_remove</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Some column attributes were removed: &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">todel</span><span class="p">))</span>

		<span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">old_n_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="c1"># Must set new shape here, otherwise the attribute manager will complain</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_cols</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">vals</span><span class="p">])</span>

		<span class="c1"># Add the columns layerwise</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">old_n_cols</span><span class="p">:</span><span class="n">n_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="LoomConnection.add_loom"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.add_loom">[docs]</a>	<span class="k">def</span> <span class="nf">add_loom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">convert_attrs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add the content of another loom file</span>

<span class="sd">		Args:</span>
<span class="sd">			other_file (str):       filename of the loom file to append</span>
<span class="sd">			key:                    Primary key to use to align rows in the other file with this file</span>
<span class="sd">			fill_values (dict):     default values to use for missing attributes (or None to drop missing attrs, or &#39;auto&#39; to fill with sensible defaults)</span>
<span class="sd">			batch_size (int):       the batch size used by batchscan (limits the number of rows/columns read in memory)</span>
<span class="sd">			convert_attrs (bool):   convert file attributes that differ between files into column attributes</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing, but adds the loom file. Note that the other loom file must have exactly the same</span>
<span class="sd">			number of rows, and must have exactly the same column attributes.</span>
<span class="sd">			The all the contents including layers but ignores layers in `other_file` that are not already persent in self</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot add data when connected in read-only mode&quot;</span><span class="p">)</span>
		<span class="c1"># Connect to the loom files</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">other_file</span><span class="p">)</span>
		<span class="c1"># Verify that the row keys can be aligned</span>
		<span class="n">ordering</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># This was original Sten&#39;s version but it creates a 400M entries array in memory</span>
			<span class="c1"># ordering = np.where(other.row_attrs[key][None, :] == self.row_attrs[key][:, None])[1]</span>

			<span class="k">def</span> <span class="nf">ixs_thatsort_a2b</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">check_content</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
				<span class="s2">&quot;This is super duper magic sauce to make the order of one list to be like another&quot;</span>
				<span class="k">if</span> <span class="n">check_content</span><span class="p">:</span>
					<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="s2">&quot;The two arrays are not matching&quot;</span>
				<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">b</span><span class="p">))]</span>

			<span class="n">ordering</span> <span class="o">=</span> <span class="n">ixs_thatsort_a2b</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="n">pk1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="n">pk2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk1</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">pk2</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Primary keys are not 1-to-1 alignable!&quot;</span><span class="p">)</span>
		<span class="n">diff_layers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is missing a layer, cannot merge with current file. layers missing:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">other_file</span><span class="p">,</span> <span class="n">diff_layers</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">convert_attrs</span><span class="p">:</span>
			<span class="c1"># Prepare to replace any global attribute that differ between looms or is missing in either loom with a column attribute.</span>
			<span class="n">globalkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
			<span class="n">globalkeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="n">globalkeys</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]:</span>
					<span class="k">continue</span>
				<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">:</span>
					<span class="n">self_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">self_value</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">:</span>
					<span class="n">other_value</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">other</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">other_value</span><span class="p">]</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
					<span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">globalkey</span><span class="p">)</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">batch_scan_layers</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
			<span class="n">ca</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
			<span class="k">if</span> <span class="n">ordering</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">ordering</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="n">fill_values</span><span class="p">)</span>
		<span class="n">other</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="LoomConnection.delete_attr"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.delete_attr">[docs]</a>	<span class="k">def</span> <span class="nf">delete_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `del ds.ra.key` or `del ds.ca.key` instead, where `key` is replaced with the attribute name</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;delete_attr&#39; is deprecated. Use &#39;del ds.ra.key&#39; or &#39;del ds.ca.key&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoomConnection.set_attr"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.set_attr">[docs]</a>	<span class="k">def</span> <span class="nf">set_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.ra.key = values` or `ds.ca.key = values` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;set_attr&#39; is deprecated. Use &#39;ds.ra.key = values&#39; or &#39;ds.ca.key = values&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span></div>

<div class="viewcode-block" id="LoomConnection.list_edges"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.list_edges">[docs]</a>	<span class="k">def</span> <span class="nf">list_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.row_graphs.keys()` or `ds.col_graphs.keys()` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;list_edges&#39; is deprecated. Use &#39;ds.row_graphs.keys()&#39; or &#39;ds.col_graphs.keys()&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="LoomConnection.get_edges"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.get_edges">[docs]</a>	<span class="k">def</span> <span class="nf">get_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.row_graphs[name]` or `ds.col_graphs[name]` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;get_edges&#39; is deprecated. Use &#39;ds.row_graphs[name]&#39; or &#39;ds.col_graphs[name]&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be 0 or 1&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.set_edges"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.set_edges">[docs]</a>	<span class="k">def</span> <span class="nf">set_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.row_graphs[name] = g` or `ds.col_graphs[name] = g` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;set_edges&#39; is deprecated. Use &#39;ds.row_graphs[name] = g&#39; or &#39;ds.col_graphs[name] = g&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input arrays could not be converted to a sparse matrix&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
		<span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be 0 (rows) or 1 (columns)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.scan"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.scan">[docs]</a>	<span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomView</span><span class="p">]]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Scan across one axis and return batches of rows (columns) as LoomView objects</span>

<span class="sd">		Args</span>
<span class="sd">		----</span>
<span class="sd">		items: np.ndarray</span>
<span class="sd">			the indexes [0, 2, 13, ... ,973] of the rows/cols to include along the axis</span>
<span class="sd">			OR: boolean mask array giving the rows/cols to include</span>
<span class="sd">		axis: int</span>
<span class="sd">			0:rows or 1:cols</span>
<span class="sd">		batch_size: int</span>
<span class="sd">			the chuncks returned at every element of the iterator</span>
<span class="sd">		layers: iterable</span>
<span class="sd">			if specified it will batch scan only across some of the layers of the loom file</span>
<span class="sd">			if layers == None, all layers will be scanned</span>
<span class="sd">			if layers == [&quot;&quot;] or &quot;&quot;, only the default layer will be scanned</span>
<span class="sd">		key:</span>
<span class="sd">			Name of primary key attribute. If specified, return the values sorted by the key</span>

<span class="sd">		Returns</span>
<span class="sd">		------</span>
<span class="sd">		Iterable that yields triplets</span>
<span class="sd">		(ix, indexes, view)</span>

<span class="sd">		ix: int</span>
<span class="sd">			first position / how many rows/cols have been yielded alredy</span>
<span class="sd">		indexes: np.ndarray[int]</span>
<span class="sd">			the indexes with the same numbering of the input args cells / genes (i.e. np.arange(len(ds.shape[axis])))</span>
<span class="sd">			this is ix + selection</span>
<span class="sd">		view: LoomView</span>
<span class="sd">			a view corresponding to the current chunk</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be given (0 = rows, 1 = cols)&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">layers</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
			<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)):</span>
			<span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">items</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

		<span class="n">ordering</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
			<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
				<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cols_per_chunk</span><span class="p">)</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">items</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the cells that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">cols_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ordering</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="n">selection</span><span class="p">]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
				<span class="n">lm</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">lm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
				<span class="n">view</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomView</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">ordering</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">ordering</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
		<span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
			<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">rows_per_chunk</span><span class="p">)</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">items</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the genes that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">rows_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="n">ordering</span><span class="p">]</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
				<span class="n">lm</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">lm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
				<span class="n">view</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomView</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">ordering</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">ordering</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be 0 or 1&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.batch_scan"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.batch_scan">[docs]</a>	<span class="k">def</span> <span class="nf">batch_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">genes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `scan` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;batch_scan&#39; is deprecated. Use &#39;scan&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">layer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
				<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cols_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">cells</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the cells that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">cols_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">genes</span><span class="p">,</span> <span class="p">:]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="n">selection</span><span class="p">]</span>

				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>

		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">rows_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">genes</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the genes that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">rows_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">,</span> <span class="p">:]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span>
				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span></div>

<div class="viewcode-block" id="LoomConnection.batch_scan_layers"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.batch_scan_layers">[docs]</a>	<span class="k">def</span> <span class="nf">batch_scan_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">genes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `scan` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;batch_scan_layers&#39; is deprecated. Use &#39;scan&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
				<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cols_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">cells</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the cells that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">cols_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">genes</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">selection</span><span class="p">]</span>

				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>

		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">rows_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">genes</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the genes that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">rows_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">cells</span><span class="p">]</span>
				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span></div>

<div class="viewcode-block" id="LoomConnection.map"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.map">[docs]</a>	<span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">int</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">selection</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Apply a function along an axis without loading the entire dataset in memory.</span>

<span class="sd">		Args:</span>
<span class="sd">			f (list of func):		Function(s) that takes a numpy ndarray as argument</span>

<span class="sd">			axis (int):		Axis along which to apply the function (0 = rows, 1 = columns)</span>

<span class="sd">			chunksize (int): Number of rows (columns) to load per chunk</span>

<span class="sd">			selection (array of bool): Columns (rows) to include</span>

<span class="sd">		Returns:</span>
<span class="sd">			numpy.ndarray result of function application</span>
<span class="sd">			The result is a list of numpy arrays, one per supplied function in f_list.</span>
<span class="sd">			This is more efficient than repeatedly calling map() one function at a time.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f_list</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.permute"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.permute">[docs]</a>	<span class="k">def</span> <span class="nf">permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordering</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Permute the dataset along the indicated axis.</span>

<span class="sd">		Args:</span>
<span class="sd">			ordering (list of int): 	The desired order along the axis</span>

<span class="sd">			axis (int):					The axis along which to permute</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;tiles&quot;</span><span class="p">):</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s1">&#39;tiles&#39;</span><span class="p">]</span>

		<span class="n">ordering</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>  <span class="c1"># Flatten the ordering, in case we got a column vector</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.export"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.LoomConnection.export">[docs]</a>	<span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Export the specified layer and row/col attributes as tab-delimited file</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">format</span> <span class="o">!=</span> <span class="s2">&quot;tab&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only &#39;tab&#39; is supported&quot;</span><span class="p">)</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="c1"># Emit column attributes</span>
			<span class="k">for</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ca</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">ca</span><span class="p">]:</span>
					<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

			<span class="c1"># Emit row attribute names</span>
			<span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ra</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

			<span class="c1"># Emit row attr values and matrix values</span>
			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
				<span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">ra</span><span class="p">][</span><span class="n">row</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">:]:</span>
						<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">row</span><span class="p">,</span> <span class="p">:]:</span>
						<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_create_sparse</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a new loom file from a sparse matrix input</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s2">&quot;Cannot overwrite existing file &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting to csc format&quot;</span><span class="p">)</span>
	<span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
	<span class="n">window</span> <span class="o">=</span> <span class="mi">6400</span>
	<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
		<span class="n">window</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">break</span>
		<span class="n">ca</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">window</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
		<span class="n">create_append</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">matrix</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">window</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span>
		<span class="n">ix</span> <span class="o">+=</span> <span class="n">window</span>


<div class="viewcode-block" id="create_append"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.create_append">[docs]</a><span class="k">def</span> <span class="nf">create_append</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">],</span> <span class="n">row_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Append columns to a loom file, or create a new loom file if it doesn&#39;t exist</span>

<span class="sd">	Args:</span>
<span class="sd">		filename (str):         The filename (typically using a `.loom` file extension)</span>
<span class="sd">		layers (np.ndarray or Dict[str, np.ndarray] or LayerManager):</span>
<span class="sd">								Two-dimensional (N-by-M) numpy ndarray of float values</span>
<span class="sd">								Or dictionary of named layers, each an N-by-M ndarray</span>
<span class="sd">								or LayerManager, each layer an N-by-M ndarray</span>
<span class="sd">		row_attrs (dict):       Row attributes, where keys are attribute names and values</span>
<span class="sd">								are numpy arrays (float or string) of length N</span>
<span class="sd">		col_attrs (dict):       Column attributes, where keys are attribute names and</span>
<span class="sd">								values are numpy arrays (float or string) of length M</span>
<span class="sd">		file_attrs (dict):      Global attributes, where keys are attribute names and</span>
<span class="sd">								values are strings</span>
<span class="sd">	Returns:</span>
<span class="sd">		Nothing</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
		<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="n">fill_values</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span></div>


<div class="viewcode-block" id="create"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.create">[docs]</a><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">],</span> <span class="n">row_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a new .loom file from the given data.</span>

<span class="sd">	Args:</span>
<span class="sd">		filename (str):         The filename (typically using a `.loom` file extension)</span>
<span class="sd">		layers (np.ndarray or scipy.sparse or Dict[str, np.ndarray] or LayerManager):</span>
<span class="sd">								Two-dimensional (N-by-M) numpy ndarray of float values</span>
<span class="sd">								Or sparse matrix</span>
<span class="sd">								Or dictionary of named layers, each an N-by-M ndarray</span>
<span class="sd">								or LayerManager, each layer an N-by-M ndarray</span>
<span class="sd">		row_attrs (dict):       Row attributes, where keys are attribute names and values</span>
<span class="sd">								are numpy arrays (float or string) of length N</span>
<span class="sd">		col_attrs (dict):       Column attributes, where keys are attribute names and</span>
<span class="sd">								values are numpy arrays (float or string) of length M</span>
<span class="sd">		file_attrs (dict):      Global attributes, where keys are attribute names and</span>
<span class="sd">								values are strings</span>
<span class="sd">	Returns:</span>
<span class="sd">		Nothing</span>

<span class="sd">	Remarks:</span>
<span class="sd">		If the file exists, it will be overwritten. See create_append for a function that will append to existing files.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;~/&quot;</span><span class="p">):</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">file_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">file_attrs</span> <span class="o">=</span> <span class="p">{}</span>

	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
		<span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">}</span>
	<span class="k">elif</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
		<span class="n">_create_sparse</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">):</span>
		<span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
	<span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data for default layer must be provided&quot;</span><span class="p">)</span>

	<span class="c1"># Create the file (empty).</span>
	<span class="c1"># Yes, this might cause an exception, which we prefer to send to the caller</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/layers&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/row_attrs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/col_attrs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/row_graphs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/col_graphs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
	<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">layer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">row_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

			<span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">file_attrs</span><span class="p">:</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_attrs</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span>

			<span class="c1"># store creation date</span>
			<span class="n">currentTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;CreationDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">()</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LOOM_SPEC_VERSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">loom_spec_version</span>

	<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
		<span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">raise</span> <span class="n">ve</span></div>


<div class="viewcode-block" id="create_from_cellranger"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.create_from_cellranger">[docs]</a><span class="k">def</span> <span class="nf">create_from_cellranger</span><span class="p">(</span><span class="n">indir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">genome</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a .loom file from 10X Genomics cellranger output</span>

<span class="sd">	Args:</span>
<span class="sd">		indir (str):	path to the cellranger output folder (the one that contains &#39;outs&#39;)</span>
<span class="sd">		outdir (str):	output folder wher the new loom file should be saved (default to indir)</span>
<span class="sd">		genome (str):	genome build to load (e.g. &#39;mm10&#39;; if None, determine species from outs folder)</span>

<span class="sd">	Returns:</span>
<span class="sd">		path (str):		Path to the created loom file.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">outdir</span> <span class="o">=</span> <span class="n">indir</span>
	<span class="n">sampleid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">indir</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">matrix_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s1">&#39;outs&#39;</span><span class="p">,</span> <span class="s1">&#39;filtered_gene_bc_matrices&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">genome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">genome</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">matrix_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="n">genome</span><span class="p">)</span>
	<span class="n">matrix</span> <span class="o">=</span> <span class="n">mmread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;matrix.mtx&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>

	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;genes.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="n">accession</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
	<span class="n">gene</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="n">cellids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sampleid</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>

	<span class="n">col_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CellID&quot;</span><span class="p">:</span> <span class="n">cellids</span><span class="p">}</span>
	<span class="n">row_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accession&quot;</span><span class="p">:</span> <span class="n">accession</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">:</span> <span class="n">gene</span><span class="p">}</span>

	<span class="n">tsne_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s2">&quot;outs&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;tsne&quot;</span><span class="p">,</span> <span class="s2">&quot;projection.csv&quot;</span><span class="p">)</span>
	<span class="c1"># In cellranger V2 the file moved one level deeper</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tsne_file</span><span class="p">):</span>
		<span class="n">tsne_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s2">&quot;outs&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;tsne&quot;</span><span class="p">,</span> <span class="s2">&quot;2_components&quot;</span><span class="p">,</span> <span class="s2">&quot;projection.csv&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tsne_file</span><span class="p">):</span>
		<span class="n">tsne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tsne_file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">col_attrs</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
		<span class="n">col_attrs</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

	<span class="n">clusters_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s2">&quot;outs&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;clustering&quot;</span><span class="p">,</span> <span class="s2">&quot;graphclust&quot;</span><span class="p">,</span> <span class="s2">&quot;clusters.csv&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">clusters_file</span><span class="p">):</span>
		<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">clusters_file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">col_attrs</span><span class="p">[</span><span class="s2">&quot;ClusterID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">sampleid</span> <span class="o">+</span> <span class="s2">&quot;.loom&quot;</span><span class="p">)</span>
	<span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Genome&quot;</span><span class="p">:</span> <span class="n">genome</span><span class="p">})</span>
	<span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="combine"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.combine">[docs]</a><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">convert_attrs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Combine two or more loom files and save as a new loom file</span>

<span class="sd">	Args:</span>
<span class="sd">		files (list of str):    the list of input files (full paths)</span>
<span class="sd">		output_file (str):      full path of the output loom file</span>
<span class="sd">		key (string):           Row attribute to use to verify row ordering</span>
<span class="sd">		file_attrs (dict):      file attributes (title, description, url, etc.)</span>
<span class="sd">		batch_size (int):       limits the batch or cols/rows read in memory (default: 1000)</span>
<span class="sd">		convert_attrs (bool):   convert file attributes that differ between files into column attributes</span>

<span class="sd">	Returns:</span>
<span class="sd">		Nothing, but creates a new loom file combining the input files.</span>

<span class="sd">	The input files must (1) have exactly the same number of rows, (2) have</span>
<span class="sd">	exactly the same sets of row and column attributes.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">file_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">file_attrs</span> <span class="o">=</span> <span class="p">{}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input file list was empty&quot;</span><span class="p">)</span>

	<span class="n">copyfile</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_file</span><span class="p">)</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">file_attrs</span><span class="p">:</span>
		<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">add_loom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">convert_attrs</span><span class="o">=</span><span class="n">convert_attrs</span><span class="p">)</span>
	<span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="connect"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.loompy.connect">[docs]</a><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LoomConnection</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Establish a connection to a .loom file.</span>

<span class="sd">	Args:</span>
<span class="sd">		filename (str):     Name of the .loom file to open</span>
<span class="sd">		mode (str):         read/write mode, accepts &#39;r+&#39; (read/write) or</span>
<span class="sd">							&#39;r&#39; (read-only), defaults to &#39;r+&#39;</span>

<span class="sd">	Returns:</span>
<span class="sd">		A LoomConnection instance.</span>

<span class="sd">	Remarks:</span>
<span class="sd">		This function should typically be called as a context manager:</span>

<span class="sd">			with loompy.connect(filename) as ds:</span>
<span class="sd">				...do something...</span>

<span class="sd">		This ensures that the file will be closed automatically when the context block ends</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">LoomConnection</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, LinnarssonLab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'2.0.10',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>